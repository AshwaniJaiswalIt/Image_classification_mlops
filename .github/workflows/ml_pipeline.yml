name: ML Pipeline CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    name: Code Quality Check (Linting)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint

    - name: Lint with flake8 (Syntax Errors)
      run: |
        echo "Checking for Python syntax errors..."
        flake8 cats_dogs_code/src cats_dogs_code/tests --count --select=E9,F63,F7,F82 --show-source --statistics

    - name: Lint with flake8 (Style Check)
      run: |
        echo "Checking code style..."
        flake8 cats_dogs_code/src cats_dogs_code/tests --count --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true

    - name: Lint with pylint
      run: |
        echo "Running pylint analysis..."
        pylint cats_dogs_code/src --exit-zero
      continue-on-error: true

    - name: Linting Summary
      run: echo "Linting stage completed"

  test:
    name: Unit Testing
    runs-on: ubuntu-latest
    needs: lint

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: Run unit tests with coverage
      run: |
        cd cats_dogs_code
        pytest tests/ -v --cov=src --cov-report=xml --cov-report=html --cov-report=term

    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-html
        path: cats_dogs_code/htmlcov/
        retention-days: 30

    - name: Upload coverage XML
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-xml
        path: cats_dogs_code/coverage.xml
        retention-days: 30

    - name: Testing Summary
      run: echo "Testing stage completed"

  train:
    name: Model Training & MLflow Tracking
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up DVC and restore dataset
      run: |
        pip install dvc
        echo "Dataset would be pulled from DVC remote in production."
        echo "Skipping dvc pull in CI (no remote configured)."

    - name: Train model with MLflow tracking
      run: |
        echo "Starting model training pipeline with MLflow..."
        python train_pipeline.py
      env:
        MLFLOW_TRACKING_URI: "mlruns"

    - name: Verify model artifact
      run: |
        echo "Verifying generated model file..."
        ls -lh cat_dog_model.h5
        ls -lh training_config.json
        echo "Model artifacts verified successfully"

    - name: Upload trained CNN model
      uses: actions/upload-artifact@v4
      with:
        name: cat-dog-cnn-model
        path: cat_dog_model.h5
        retention-days: 30

    - name: Upload model plots
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: training-plots
        path: |
          confusion_matrix.png
          training_curves.png
        retention-days: 30

    - name: Upload training config
      uses: actions/upload-artifact@v4
      with:
        name: training-config
        path: training_config.json
        retention-days: 30

    - name: Upload MLflow runs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mlflow-runs
        path: mlruns/
        retention-days: 30

    - name: Training Summary
      run: |
        echo "=================================="
        echo "MODEL TRAINING SUMMARY"
        echo "=================================="
        echo "Model: Simple CNN (Binary - Cats vs Dogs)"
        echo "Artifacts: cat_dog_model.h5, confusion_matrix.png, training_curves.png"
        echo "Tracking: MLflow (see mlruns/)"
        echo "=================================="

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [lint, test, train]
    if: always()

    steps:
    - name: Pipeline Status
      run: |
        echo "=================================="
        echo "ML PIPELINE EXECUTION SUMMARY"
        echo "CATS VS DOGS CLASSIFICATION"
        echo "=================================="
        echo "Stage 1: Linting - Completed"
        echo "Stage 2: Testing - Completed"
        echo "Stage 3: Training + MLflow - Completed"
        echo "=================================="
        echo "All stages executed successfully!"
